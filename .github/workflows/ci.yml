name: ğŸ”§ CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '18.x'
  CACHE_VERSION: 'v1'

jobs:
  # ğŸ•µï¸ Code Quality Checks
  quality:
    name: ğŸ“ Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“‹ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        npm ci
        npm ls --depth=0
    
    - name: ğŸ” Lint code
      run: |
        npm run lint
        npm run lint:css
    
    - name: ğŸ¨ Check formatting
      run: npm run format:check
    
    - name: ğŸ”’ Type check
      run: npm run type-check
      
    - name: ğŸ“Š Analyze bundle
      run: npm run analyze

  # ğŸ§ª Testing Suite
  test:
    name: ğŸ§ª Tests
    runs-on: ubuntu-latest
    needs: quality
    
    strategy:
      matrix:
        node-version: ['16.x', '18.x', '20.x']
    
    steps:
    - name: ğŸ“‹ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: ğŸ“¦ Install dependencies
      run: npm ci
    
    - name: ğŸ§ª Run unit tests
      run: npm run test:unit -- --coverage
    
    - name: ğŸ”— Run integration tests
      run: npm run test:integration
    
    - name: ğŸ“Š Upload coverage
      if: matrix.node-version == '18.x'
      uses: codecov/codecov-action@v3
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella

  # ğŸ” Security Checks
  security:
    name: ğŸ”’ Security
    runs-on: ubuntu-latest
    needs: quality
    
    steps:
    - name: ğŸ“‹ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: ğŸ“¦ Install dependencies
      run: npm ci
    
    - name: ğŸ” Security audit
      run: npm audit --audit-level=moderate
    
    - name: ğŸ•µï¸ License check
      run: npm run license-check
    
    - name: ğŸ› CodeQL Analysis
      uses: github/codeql-action/init@v2
      with:
        languages: javascript
    
    - name: ğŸ•µï¸ Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2

  # ğŸ—ï¸ Build & Deploy
  build:
    name: ğŸ—ï¸ Build
    runs-on: ubuntu-latest
    needs: [quality, test, security]
    
    steps:
    - name: ğŸ“‹ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: ğŸ“¦ Install dependencies
      run: npm ci
    
    - name: ğŸ—ï¸ Build project
      run: |
        npm run build
        npm run build:docs
    
    - name: ğŸ“ Generate build info
      run: |
        echo "Build Date: $(date)" > dist/build-info.txt
        echo "Commit: ${{ github.sha }}" >> dist/build-info.txt
        echo "Branch: ${{ github.ref_name }}" >> dist/build-info.txt
    
    - name: ğŸ“ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-files
        path: |
          dist/
          docs/
        retention-days: 30
    
    - name: ğŸ“¦ Build Docker image
      if: github.ref == 'refs/heads/main'
      run: |
        docker build -t ${{ github.repository }}:latest .
        docker build -t ${{ github.repository }}:${{ github.sha }} .

  # ğŸš€ Deploy to Staging
  deploy-staging:
    name: ğŸš€ Deploy Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop'
    environment:
      name: staging
      url: https://staging.ejemplo.com
    
    steps:
    - name: ğŸ“‹ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ“¥ Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-files
        path: dist/
    
    - name: ğŸš€ Deploy to staging
      run: |
        echo "Deploying to staging environment..."
        # AquÃ­ irÃ­an los comandos de deploy reales
        # Por ejemplo: rsync, scp, deploy to cloud, etc.
    
    - name: ğŸ’¬ Notify deployment
      if: always()
      run: |
        echo "Staging deployment completed for commit ${{ github.sha }}"

  # ğŸ† Deploy to Production
  deploy-production:
    name: ğŸ† Deploy Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://ejemplo.com
    
    steps:
    - name: ğŸ“‹ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ“¥ Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-files
        path: dist/
    
    - name: ğŸ† Deploy to production
      run: |
        echo "Deploying to production environment..."
        # Comandos de deploy a producciÃ³n
    
    - name: ğŸ† Create GitHub Release
      if: contains(github.event.head_commit.message, 'release:')
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ github.run_number }}
        release_name: Release v${{ github.run_number }}
        body: |
          ## ğŸ‰ Nueva Release
          
          ### ğŸš€ Cambios
          ${{ github.event.head_commit.message }}
          
          ### ğŸ“Š EstadÃ­sticas
          - Commit: ${{ github.sha }}
          - Fecha: $(date)
          - Autor: ${{ github.actor }}
        draft: false
        prerelease: false

  # ğŸ”„ Performance Tests
  performance:
    name: ğŸ“Š Performance
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ“‹ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ“¥ Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-files
        path: dist/
    
    - name: ğŸ“Š Lighthouse CI
      uses: treosh/lighthouse-ci-action@v9
      with:
        configPath: './.lighthouserc.json'
        uploadArtifacts: true
        temporaryPublicStorage: true
    
    - name: ğŸš€ Bundle size check
      run: |
        npm install -g bundlesize
        bundlesize

  # ğŸ“Š Metrics & Monitoring
  metrics:
    name: ğŸ“Š Metrics
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“‹ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ“Š Generate metrics
      run: |
        echo "Generating project metrics..."
        
        # Contar lÃ­neas de cÃ³digo
        find src -name '*.js' -o -name '*.ts' -o -name '*.jsx' -o -name '*.tsx' | xargs wc -l
        
        # Contar archivos por tipo
        echo "Files by extension:"
        find src -type f | sed 's/.*\.//' | sort | uniq -c | sort -rn
        
        # TamaÃ±o del repositorio
        echo "Repository size:"
        du -sh .
    
    - name: ğŸ’¬ Update project stats
      run: |
        echo "Updating project statistics in README..."
        # AquÃ­ se podrÃ­an actualizar badges dinÃ¡micamente